<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Royal Rajshri - Official App</title>
    
    <!-- Firebase SDKs -->
    <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
    
    <!-- Fonts & Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --bg-dark: #050505; --card-bg: #141414;
            --gold: #FFD700; --gold-grad: linear-gradient(135deg, #FFD700 0%, #FDB931 100%);
            --neon-green: #00ff9d; --neon-red: #ff0055;
            --glass: rgba(255, 255, 255, 0.08);
            --border: 1px solid rgba(255, 255, 255, 0.15);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            font-family: 'Poppins', sans-serif; background-color: var(--bg-dark); color: white;
            margin: 0; padding-bottom: 80px; height: 100vh; display: flex; flex-direction: column;
            background-image: radial-gradient(circle at top, #1a1a2e 0%, #000 70%);
            overflow-x: hidden;
        }

        .swal2-container { z-index: 10000 !important; }
        input { user-select: text !important; -webkit-user-select: text !important; pointer-events: auto !important; z-index: 100 !important; position: relative; }

        /* --- OFFLINE SCREEN --- */
        #offline-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0a0a0a; z-index: 9999;
            display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center;
        }

        /* --- LOGIN SCREEN --- */
        #auth-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #000000 0%, #1a0b00 100%); z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .login-card { background: rgba(20, 20, 20, 0.85); width: 85%; max-width: 360px; padding: 30px 25px; border-radius: 20px; text-align: center; border: 1px solid rgba(255, 215, 0, 0.15); backdrop-filter: blur(15px); max-height: 90vh; overflow-y: auto; }
        
        .input-group { position: relative; margin-bottom: 15px; text-align: left; }
        .input-group i.field-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--gold); }
        .input-group i.eye-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #666; padding: 10px; z-index: 10; }
        .auth-input { width: 100%; padding: 12px 45px; background: rgba(0, 0, 0, 0.7); border: 1px solid rgba(255, 255, 255, 0.3); color: white; border-radius: 12px; transition: 0.3s; font-size: 0.9rem; }
        .auth-input:focus { border-color: var(--gold); background: rgba(0, 0, 0, 0.95); }

        .btn-auth { width: 100%; background: var(--gold-grad); border: none; padding: 12px; font-weight: 700; color: #1a1a1a; border-radius: 12px; cursor: pointer; margin-top: 5px; transition: 0.3s; font-size: 1rem; }
        .btn-auth:disabled { background: #444; color: #888; cursor: not-allowed; opacity: 0.7; }

        .toggle-link { color: var(--gold); margin-top: 15px; display: block; cursor: pointer; font-size: 0.8rem; text-decoration: underline; }

        /* GOOGLE BUTTON */
        .btn-google {
            width: 100%;
            background: white;
            color: #333;
            border: none;
            padding: 12px;
            border-radius: 30px;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: 0.3s;
        }
        .btn-google:hover { background: #f1f1f1; transform: scale(1.02); }

        /* HEADER */
        .app-header { padding: 15px; background: rgba(10,10,10,0.95); display: flex; justify-content: space-between; align-items: center; border-bottom: var(--border); position: sticky; top: 0; z-index: 50; }
        .logo { font-family: 'Orbitron'; font-size: 1.2rem; color: var(--gold); }
        .wallet-pill { padding: 5px 15px; border: 1px solid var(--gold); border-radius: 20px; color: var(--gold); font-weight: bold; background: rgba(255, 215, 0, 0.1); }

        /* TABS */
        .tab-content { display: none; flex: 1; overflow-y: auto; padding: 10px; }
        .tab-content.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* GAME UI */
        .timer-card { background: linear-gradient(145deg, #1a1a1a, #0a0a0a); border-radius: 12px; padding: 15px; border: var(--border); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; transition: 0.3s; }
        .timer-card.frozen { border-color: var(--neon-red); background: rgba(255, 0, 85, 0.1); }
        
        .timer-display { font-family: 'Orbitron'; font-size: 2rem; font-weight: bold; color: var(--gold); }
        .frozen .timer-display { color: var(--neon-red); }
        
        .status-badge { font-size: 0.7rem; background: var(--neon-green); color: black; padding: 2px 8px; border-radius: 4px; font-weight: bold; }
        .frozen .status-badge { background: var(--neon-red); color: white; }

        .game-controls { display: flex; gap: 10px; margin-bottom: 15px; background: #111; padding: 5px; border-radius: 10px; border: 1px solid #333; }
        .ctrl-btn { flex: 1; padding: 10px; border: none; background: transparent; color: #666; font-weight: bold; border-radius: 8px; cursor: pointer; transition: 0.3s; }
        .ctrl-btn.active { background: var(--gold-grad); color: black; }
        .game-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; padding-bottom: 20px; }
        .game-grid.jodi-mode { grid-template-columns: repeat(10, 1fr); gap: 5px; } 
        .num-btn { aspect-ratio: 1; background: var(--glass); border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-weight: 500; color: #ccc; }
        .num-btn:active { transform: scale(0.9); }
        
        .disabled-grid { opacity: 0.3; pointer-events: none; }

        /* HISTORY & PROFILE */
        .hist-item { padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; background: #111; margin-bottom: 5px; border-radius: 8px; }
        .hist-ball { width: 45px; height: 45px; background: var(--gold); color: black; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-family: 'Orbitron'; font-size: 1.4rem; }
        
        .tx-item { padding: 12px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; background: #161616; margin-bottom: 5px; border-radius: 6px; }

        .profile-card { background: #1a1a1a; border-radius: 15px; padding: 20px; margin-bottom: 15px; text-align: center; border: 1px solid #333; }
        .user-avatar { width: 80px; height: 80px; background: #333; border-radius: 50%; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: var(--gold); border: 2px solid var(--gold); }
        .info-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #333; color: #ccc; font-size: 0.9rem; }

        /* MODALS */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1500; display: none; align-items: center; justify-content: center; }
        .modal-box { background: #141414; width: 90%; max-width: 400px; padding: 25px; border-radius: 16px; border: 1px solid #444; text-align: center; max-height: 90vh; overflow-y: auto;}
        
        .modal-inp { 
            width: 100%; 
            padding: 15px; 
            background: #000000; 
            border: 1px solid #333; 
            color: white; 
            margin: 10px 0; 
            border-radius: 8px; 
            text-align: center; 
            font-size: 1.1rem; 
            font-weight: 500;
        }
        .modal-inp::placeholder { color: #666; font-size: 1rem; }
        .modal-inp:focus { border-color: var(--gold); }

        .btn-close { background: transparent; border: none; color: #888; margin-top: 15px; cursor: pointer; text-decoration: underline; font-size: 1rem; }
        
        .copy-input-container { position: relative; margin: 10px 0; }
        .copy-icon-inside { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--gold); cursor: pointer; font-size: 1.2rem; }

        /* WITHDRAW TAB BUTTONS */
        .w-tabs { display: flex; gap: 10px; margin-bottom: 15px; background: #111; padding: 5px; border-radius: 8px; }
        .w-type-btn { flex: 1; padding: 10px; border: none; background: transparent; color: #888; font-weight: bold; border-radius: 6px; cursor: pointer; border: 1px solid transparent;}
        .w-type-btn.active { background: #333; color: white; border-color: #555; }
        
        .wit-section { display: none; animation: fadeIn 0.3s; }

        /* NAV */
        .nav-bar { position: fixed; bottom: 0; width: 100%; height: 65px; background: #0a0a0a; border-top: var(--border); display: flex; justify-content: space-around; align-items: center; z-index: 100; }
        .nav-item { color: #666; font-size: 0.75rem; text-align: center; background:none; border:none; display:flex; flex-direction:column; align-items:center; gap:5px; width: 100%; height: 100%; justify-content: center; }
        .nav-item.active { color: var(--gold); background: rgba(255,255,255,0.03); }

        /* RESULT OVERLAY */
        #result-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.96); z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .slot-num { font-family: 'Orbitron'; font-size: 6rem; color: white; text-shadow: 0 0 50px var(--gold); margin-bottom: 20px; }
        .win-anim { color: var(--neon-green) !important; text-shadow: 0 0 20px var(--neon-green); font-size: 1.5rem !important; animation: pulseGreen 1s infinite alternate; }
        @keyframes pulseGreen { from { transform: scale(1); } to { transform: scale(1.1); } }
    </style>
</head>
<body>

    <div id="offline-screen">
        <i class="fas fa-wifi" style="font-size: 4rem; color: #333; margin-bottom: 20px;"></i>
        <h2 style="color: white; margin: 0;">CONNECTION LOST</h2>
        <button class="btn-auth" style="width: auto; padding: 10px 30px; margin-top: 20px;" onclick="window.location.reload()">RETRY</button>
    </div>

    <!-- LOGIN -->
    <div id="auth-modal">
        <div class="login-card">
            <i class="fas fa-crown" style="font-size: 2.5rem; color: var(--gold); margin-bottom:5px;"></i>
            <h2 style="color:white; margin:5px 0; font-family:'Orbitron';">RAJSHRI</h2>
            <p style="color:#888; font-size:0.8rem; margin-bottom:20px;">Welcome Back!</p>
            
            <!-- EMAIL / PASS INPUTS -->
            <div class="input-group">
                <i class="fas fa-envelope field-icon"></i>
                <input type="email" id="email" class="auth-input" placeholder="Email Address">
            </div>
            <div class="input-group">
                <i class="fas fa-lock field-icon"></i>
                <input type="password" id="pass" class="auth-input" placeholder="Password">
                <i class="fas fa-eye field-icon eye-icon" id="eye-toggle" onclick="window.togglePass()"></i>
            </div>
            
            <button class="btn-auth" id="email-login-btn" onclick="window.handleEmailAuth()">LOGIN</button>
            <span class="toggle-link" id="toggle-auth-mode" onclick="window.toggleAuthMode()">New here? Create Account</span>

            <!-- DIVIDER -->
            <div style="margin: 20px 0; display:flex; align-items:center; color:#555;">
                <div style="height:1px; background:#333; flex:1;"></div>
                <div style="padding:0 10px; font-size:0.8rem;">OR</div>
                <div style="height:1px; background:#333; flex:1;"></div>
            </div>

            <!-- GOOGLE BUTTON -->
            <button class="btn-google" id="google-login-btn" onclick="window.handleGoogleAuth()">
                <i class="fab fa-google" style="color: #DB4437; font-size: 1.1rem;"></i>
                Login with Google
            </button>
            
            <p style="color:#444; font-size:0.7rem; margin-top:20px;">256-bit Secure Encryption</p>
        </div>
    </div>

    <!-- MAIN APP -->
    <header class="app-header">
        <div class="logo"><i class="fas fa-crown"></i> RAJSHRI</div>
        <div class="wallet-pill">‚Çπ<span id="bal-head">0</span></div>
    </header>

    <!-- TAB: PLAY -->
    <div id="tab-play" class="tab-content active">
        <div class="timer-card" id="timer-box">
            <div>
                <div style="font-size:0.7rem; color:#888;">STATUS: <span id="game-status" class="status-badge">OPEN</span></div>
                <div class="timer-display" id="timer">00:00</div>
            </div>
            <div style="text-align:right;">
                <div style="font-size:0.7rem; color:#888;">Round ID</div>
                <div style="font-weight:bold; color:var(--gold); font-family:monospace;" id="rid">...</div>
            </div>
        </div>

        <div class="game-controls">
            <button class="ctrl-btn active" id="mode-jodi" onclick="window.setMode('JODI')">JODI</button>
            <button class="ctrl-btn" id="mode-open" onclick="window.setMode('OPEN')">OPEN</button>
            <button class="ctrl-btn" id="mode-close" onclick="window.setMode('CLOSE')">CLOSE</button>
        </div>

        <div style="text-align:center; margin-bottom:10px; font-size:0.8rem; color:#aaa;" id="bet-hint">Tap a number to bet</div>
        
        <!-- GRID -->
        <div class="game-grid jodi-mode" id="grid"></div>
        
        <!-- BUTTON TO OPEN BETS POPUP -->
        <button class="btn-auth" style="background:#222; border:1px solid #333; color:var(--gold); margin-top:15px;" onclick="window.openBetsModal()">
            <i class="fas fa-ticket-alt"></i> üéüÔ∏è View & Cancel Bets
        </button>
    </div>

    <!-- TAB: WALLET -->
    <div id="tab-wallet" class="tab-content">
        <div style="background: linear-gradient(135deg, #222, #111); padding: 25px; border-radius: 15px; text-align: center; border: var(--border); margin-bottom: 20px;">
            <small style="color:#aaa">Available Balance</small>
            <h1 style="font-size:2.5rem; margin:5px 0; color:white;">‚Çπ<span id="bal-main">0</span></h1>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-auth" style="background:#2ecc71; color:white;" onclick="window.openDep()">Deposit</button>
                <button class="btn-auth" style="background:#e74c3c; color:white;" onclick="window.openWit()">Withdraw</button>
            </div>
        </div>
        <h4 style="margin:10px 0; color:var(--gold);">Transaction History</h4>
        <div id="tx-list"></div>
    </div>

    <!-- TAB: RESULTS -->
    <div id="tab-results" class="tab-content">
        <h3 style="color:var(--gold); text-align:center;">Result History</h3>
        <div id="hist-list">
            <div style="text-align:center; padding:20px; color:#555;">Loading Results...</div>
        </div>
    </div>

    <!-- TAB: PROFILE -->
    <div id="tab-profile" class="tab-content">
        <h3 style="color:white; text-align:center;">My Profile</h3>
        <div class="profile-card">
            <div class="user-avatar"><img id="p-img" src="" style="width:100%; height:100%; border-radius:50%; object-fit:cover; display:none;"><i class="fas fa-user" id="p-def-icon"></i></div>
            <div id="p-email" style="font-weight:bold; color:white; margin-bottom:5px;">user@email.com</div>
            <div style="font-size:0.8rem; color:var(--gold);">Member</div>
            <div style="margin-top:20px; text-align:left;">
                <div class="info-row"><span>Member ID</span><span id="p-uid" style="color:white; font-family:monospace;">...</span></div>
                <div class="info-row"><span>Current Balance</span><span id="p-bal" style="color:var(--gold);">‚Çπ0</span></div>
                <div class="info-row"><span>Status</span><span style="color:#00ff9d;">Active</span></div>
            </div>
        </div>
        <button class="btn-auth" style="background:#333; color:var(--neon-red); margin-top:30px; border:1px solid var(--neon-red);" onclick="window.logout()">
            <i class="fas fa-sign-out-alt" style="margin-right:8px;"></i> LOGOUT
        </button>
    </div>

    <!-- MODALS -->
    
    <!-- BETTING MODAL -->
    <div id="bet-popup" class="modal">
        <div class="modal-box">
            <div style="font-size:0.9rem; color:#888;" id="pop-type">JODI</div>
            <h3 style="color:white; margin:0;">Number: <span id="pop-num" style="color:var(--gold); font-size: 2rem; display:block; margin:5px 0;">--</span></h3>
            <p style="font-size:0.8rem; color:#666; margin:5px 0;">Min: ‚Çπ1 | Max: ‚Çπ1000</p>
            <input type="number" id="bet-amt" class="modal-inp" placeholder="Enter Amount">
            <button class="btn-auth" id="btn-confirm-bet" onclick="window.placeBet()">CONFIRM BET</button>
            <button class="btn-close" onclick="document.getElementById('bet-popup').style.display='none'">Cancel</button>
        </div>
    </div>

    <!-- VIEW BETS MODAL -->
    <div id="view-bets-modal" class="modal">
        <div class="modal-box">
            <h3 style="color:var(--gold); margin-top:0;">MY BETS</h3>
            <p style="font-size:0.8rem; color:#888;">Current Round: <span id="vb-rid" style="color:white;">...</span></p>
            <div id="vb-list" style="max-height: 250px; overflow-y: auto; text-align: left; margin: 15px 0; border: 1px solid #333; padding: 10px; border-radius: 8px; background: #000;">
                <div style="text-align:center; color:#555;">Loading...</div>
            </div>
            <button class="btn-close" onclick="document.getElementById('view-bets-modal').style.display='none'">Close</button>
        </div>
    </div>
    
    <!-- DEPOSIT MODAL (FAST UPLOAD) -->
    <div id="dep-modal" class="modal">
        <div class="modal-box">
            <h3 style="color:var(--gold); margin-top:0;">ADD FUNDS</h3>
            
            <div style="background:white; padding:15px; border-radius:12px; display:inline-block; margin-bottom:20px; box-shadow: 0 0 15px rgba(0,0,0,0.5);">
                <img id="dep-qr-img" src="https://via.placeholder.com/150?text=QR+Code" style="width:160px; height:160px; object-fit:contain; display:block;" alt="QR Code">
            </div>

            <!-- UPI COPY SECTION -->
            <div class="copy-input-container">
                <input type="text" id="dep-upi-txt-val" class="modal-inp" readonly value="admin@upi" style="text-align:left; padding-right:40px; color:#ddd; font-size:0.9rem; margin:0;">
                <i class="fas fa-copy copy-icon-inside" onclick="window.copyUpi()"></i>
            </div>
            
            <input type="number" id="d-amt" class="modal-inp" placeholder="Enter Amount (‚Çπ)">
            <input type="text" id="d-utr" class="modal-inp" placeholder="UTR / Ref No. (12 Digits)">
            
            <!-- Styled File Input -->
            <div style="position: relative; margin: 15px 0;">
                <label for="d-file" style="display:block; width:100%; padding:12px; background:#222; border:1px solid #444; border-radius:8px; color:#aaa; cursor:pointer;">
                    <i class="fas fa-camera"></i> Choose Screenshot
                </label>
                <input type="file" id="d-file" accept="image/*" style="opacity:0; position:absolute; top:0; left:0; width:100%; height:100%; cursor:pointer;">
                <div id="file-name-disp" style="font-size:0.75rem; color:var(--gold); margin-top:5px;"></div>
            </div>

            <button id="btn-dep-sub" class="btn-auth" style="height:50px;" onclick="window.subDep()">SUBMIT REQUEST</button>
            <button class="btn-close" onclick="document.getElementById('dep-modal').style.display='none'">Close</button>
        </div>
    </div>

    <!-- WITHDRAW MODAL -->
    <div id="wit-modal" class="modal">
        <div class="modal-box">
            <h3 style="color:var(--neon-red); margin-top:0;">WITHDRAW</h3>
            
            <div class="w-tabs">
                <button class="w-type-btn active" id="btn-upi" onclick="window.setWitMode('UPI')">UPI</button>
                <button class="w-type-btn" id="btn-bank" onclick="window.setWitMode('BANK')">BANK TRANSFER</button>
            </div>

            <input type="number" id="w-amt" class="modal-inp" placeholder="Amount (‚Çπ)">
            <input type="text" id="w-name" class="modal-inp" placeholder="Account Holder Name">

            <div id="sec-upi" class="wit-section" style="display:block;">
                <input type="text" id="w-upi-id" class="modal-inp" placeholder="Enter UPI ID (e.g. 98xxx@ybl)">
            </div>

            <div id="sec-bank" class="wit-section">
                <input type="text" id="w-acc" class="modal-inp" placeholder="Account Number">
                <input type="text" id="w-ifsc" class="modal-inp" placeholder="IFSC Code">
                <input type="text" id="w-bname" class="modal-inp" placeholder="Bank Name">
            </div>

            <button id="btn-wit-sub" class="btn-auth" style="background:var(--neon-red); color:white; margin-top:15px;" onclick="window.subWit()">REQUEST WITHDRAW</button>
            <button class="btn-close" onclick="document.getElementById('wit-modal').style.display='none'">Close</button>
        </div>
    </div>

    <!-- NAV -->
    <nav class="nav-bar">
        <button class="nav-item active" onclick="window.tab('play', this)"><i class="fas fa-gamepad"></i>Play</button>
        <button class="nav-item" onclick="window.tab('results', this)"><i class="fas fa-list"></i>Results</button>
        <button class="nav-item" onclick="window.tab('wallet', this)"><i class="fas fa-wallet"></i>Wallet</button>
        <button class="nav-item" onclick="window.tab('profile', this)"><i class="fas fa-user"></i>Profile</button>
    </nav>

    <!-- RESULT ANIMATION OVERLAY -->
    <div id="result-overlay">
        <h2 id="res-title" style="color:white; letter-spacing:2px;">RESULT DECLARED</h2>
        <div class="slot-num" id="slot-display">00</div>
        <div id="res-msg">Checking bets...</div>
        <button class="btn-auth" style="width:auto; padding:10px 40px; margin-top:30px;" onclick="document.getElementById('result-overlay').style.display='none'">CONTINUE</button>
    </div>

    <!-- SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getDatabase, ref, set, update, onValue, push, query, limitToLast, onChildAdded, serverTimestamp, get, remove } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        // CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyCHB0T-r56i-g7DAGoasV02Stas5KuKjxw",
            authDomain: "raju-lottery.firebaseapp.com",
            databaseURL: "https://raju-lottery-default-rtdb.firebaseio.com",
            projectId: "raju-lottery",
            storageBucket: "raju-lottery.firebasestorage.app",
            messagingSenderId: "794142903854",
            appId: "1:794142903854:web:a1fbcf74711d927745d9bf",
            measurementId: "G-SR2BL3KKS3"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const googleProvider = new GoogleAuthProvider();

        let user = null, bal = 0, curRound = "", curNum = null, curGameMode = "JODI";
        let isBetting = false; 
        let isFrozen = false; 
        let pendingResultData = null; 
        let globalHistoryData = []; 
        let witMethod = "UPI"; 
        let isTransacting = false;
        let isRegistering = false; // Toggle for login/register for email

        // SERVER TIME OFFSET
        let serverTimeOffset = 0;
        onValue(ref(db, ".info/serverTimeOffset"), (snap) => {
            serverTimeOffset = snap.val() || 0;
        });

        function getServerDate() {
            return new Date(Date.now() + serverTimeOffset);
        }

        // Network Check
        window.addEventListener('offline', () => { document.getElementById('offline-screen').style.display = 'flex'; });
        window.addEventListener('online', () => { document.getElementById('offline-screen').style.display = 'none'; });
        if(!navigator.onLine) document.getElementById('offline-screen').style.display = 'flex';

        // Toggle Password
        window.togglePass = () => {
            const p = document.getElementById('pass');
            const i = document.getElementById('eye-toggle');
            if(p.type==="password"){ p.type="text"; i.classList.remove('fa-eye'); i.classList.add('fa-eye-slash'); }
            else { p.type="password"; i.classList.remove('fa-eye-slash'); i.classList.add('fa-eye'); }
        };

        // Handle File Input Change (Show Filename)
        document.getElementById('d-file').addEventListener('change', function(e){
            let fileName = e.target.files[0] ? e.target.files[0].name : "";
            document.getElementById('file-name-disp').innerText = fileName;
        });

        // --- AUTH LOGIC (HYBRID) ---
        
        // 1. Switch Email Mode (Login <-> Register)
        window.toggleAuthMode = () => {
            isRegistering = !isRegistering;
            const btn = document.getElementById('email-login-btn');
            const link = document.getElementById('toggle-auth-mode');
            if(isRegistering) {
                btn.innerText = "CREATE ACCOUNT";
                link.innerText = "Already have an account? Login";
            } else {
                btn.innerText = "LOGIN";
                link.innerText = "New here? Create Account";
            }
        };

        // 2. Handle Email Auth
        window.handleEmailAuth = () => {
            const e = document.getElementById('email').value.trim();
            const p = document.getElementById('pass').value.trim();
            if(!e || !p) return Swal.fire({icon:'warning', text:'Enter Email & Password', background:'#1a1a1a', color:'#fff'});
            
            const btn = document.getElementById('email-login-btn');
            btn.disabled = true;

            if (isRegistering) {
                // Register
                createUserWithEmailAndPassword(auth, e, p)
                .then((cred) => {
                    set(ref(db, 'users/' + cred.user.uid), {
                        email: e,
                        balance: 0,
                        createdAt: serverTimestamp()
                    });
                })
                .catch(err => {
                    btn.disabled = false;
                    Swal.fire({icon:'error', title:'Error', text: err.message, background:'#0a0a0a', color:'#fff'});
                });
            } else {
                // Login
                signInWithEmailAndPassword(auth, e, p).catch(err => {
                    btn.disabled = false;
                    Swal.fire({
                        icon: 'error',
                        title: 'ACCESS DENIED',
                        html: '<div style="text-align:left; font-size:0.9rem;">Security Alert: <br>Invalid Email or Password.</div>',
                        background: '#0a0a0a',
                        color: '#ff4444',
                        confirmButtonColor: '#d33',
                        confirmButtonText: 'TRY AGAIN'
                    });
                });
            }
        };

        // 3. Handle Google Auth
        window.handleGoogleAuth = () => {
            const btn = document.getElementById('google-login-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';

            signInWithPopup(auth, googleProvider)
            .then((result) => {
                const u = result.user;
                // Check if user exists in DB, if not create
                get(ref(db, 'users/' + u.uid)).then((snapshot) => {
                    if (!snapshot.exists()) {
                        set(ref(db, 'users/' + u.uid), {
                            email: u.email,
                            balance: 0,
                            name: u.displayName || "User",
                            createdAt: serverTimestamp()
                        });
                    }
                });
            })
            .catch((error) => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fab fa-google" style="color:#DB4437; font-size:1.1rem;"></i> Login with Google';
                Swal.fire({icon:'error', title:'Login Failed', text: error.message, background:'#0a0a0a', color:'#fff'});
            });
        };

        window.logout = () => signOut(auth).then(()=>window.location.reload());

        onAuthStateChanged(auth, u=>{
            if(u){
                user = u; document.getElementById('auth-modal').style.display='none';
                document.getElementById('p-email').innerText = u.email;
                document.getElementById('p-uid').innerText = u.uid.substring(0, 10) + "...";
                
                // Show profile pic if available (Google)
                if(u.photoURL){
                    document.getElementById('p-img').src = u.photoURL;
                    document.getElementById('p-img').style.display = 'block';
                    document.getElementById('p-def-icon').style.display = 'none';
                }

                onValue(ref(db,'users/'+u.uid+'/balance'), s=>{ 
                    bal = s.val() || 0; 
                    document.getElementById('bal-head').innerText = bal; 
                    document.getElementById('bal-main').innerText = bal; 
                    document.getElementById('p-bal').innerText = "‚Çπ" + bal;
                });
                
                loadTx(); fetchHist(); listenResult();
                
                onValue(ref(db, 'admin_settings/active_payment'), snap => {
                    if(snap.exists()){
                        const d = snap.val();
                        if(d.qr_code) document.getElementById('dep-qr-img').src = d.qr_code;
                        if(d.upi_id) document.getElementById('dep-upi-txt-val').value = d.upi_id;
                    }
                });
            } else {
                document.getElementById('auth-modal').style.display='flex';
            }
        });

        // --- TIMER ---
        setInterval(()=>{
            let d = getServerDate();
            let min = d.getMinutes();
            let sec = d.getSeconds();
            let modMin = min % 15;
            let secondsInRound = (modMin * 60) + sec;
            let totalRoundSeconds = 15 * 60; 
            let remainingSeconds = totalRoundSeconds - secondsInRound;

            let dispMin = Math.floor(remainingSeconds / 60).toString().padStart(2, '0');
            let dispSec = (remainingSeconds % 60).toString().padStart(2, '0');
            document.getElementById('timer').innerText = `${dispMin}:${dispSec}`;

            if(pendingResultData !== null && (Date.now() + serverTimeOffset) >= pendingResultData.triggerTime) {
                showFinalResult(pendingResultData);
                pendingResultData = null; 
                setTimeout(() => updateRoundID(), 2000); 
            }

            // AUTO-REFRESH RESULTS IF NEW ROUND STARTED
            if (secondsInRound < 5) {
                renderHistoryUI();
            }
            
            // Lock last 2 mins
            if(remainingSeconds <= 120) {
                isFrozen = true;
                document.getElementById('timer-box').classList.add('frozen');
                document.getElementById('game-status').innerText = "CLOSED";
                document.getElementById('grid').classList.add('disabled-grid');
                document.getElementById('bet-hint').innerText = "Betting Closed. Result coming soon...";
            } else {
                isFrozen = false;
                document.getElementById('timer-box').classList.remove('frozen');
                document.getElementById('game-status').innerText = "OPEN";
                document.getElementById('grid').classList.remove('disabled-grid');
                document.getElementById('bet-hint').innerText = "Tap a number to bet";
            }

            if(!pendingResultData && remainingSeconds > 5) updateRoundID();
        }, 1000);

        function updateRoundID() {
            let d = getServerDate();
            let m = d.getMinutes();
            let remainder = 15 - (m % 15);
            let nextDraw = new Date(d.getTime() + remainder * 60000);
            let Y=nextDraw.getFullYear(), M=(nextDraw.getMonth()+1).toString().padStart(2,'0'), D=nextDraw.getDate().toString().padStart(2,'0');
            let H=nextDraw.getHours().toString().padStart(2,'0');
            let nextMin = Math.ceil((m + 1) / 15) * 15;
            if (nextMin === 60) nextMin = "00"; else nextMin = nextMin.toString().padStart(2,'0');
            let rid = `${Y}-${M}-${D}-${H}-${nextMin}`;
            if(curRound !== rid){ curRound = rid; document.getElementById('rid').innerText = rid; }
        }

        window.setMode = (mode) => {
            curGameMode = mode;
            document.querySelectorAll('.ctrl-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('mode-'+mode.toLowerCase()).classList.add('active');
            renderGrid();
        }

        function renderGrid(){
            const g = document.getElementById('grid'); g.innerHTML = "";
            let limit = (curGameMode === "OPEN" || curGameMode === "CLOSE") ? 10 : 100;
            let isSingle = (limit === 10);
            if(isSingle) g.classList.remove('jodi-mode'); else g.classList.add('jodi-mode');
            for(let i=0; i<limit; i++){
                let n = isSingle ? i.toString() : i.toString().padStart(2,'0');
                let b = document.createElement('div'); b.className = 'num-btn'; b.innerText = n;
                b.onclick = () => { 
                    if(isFrozen) return Swal.fire({icon:'info', title:'Betting Closed', text:'Wait for result declaration', background:'#1a1a1a', color:'#fff'});
                    curNum = n; 
                    document.getElementById('pop-type').innerText = curGameMode; 
                    document.getElementById('pop-num').innerText = n; 
                    document.getElementById('bet-popup').style.display = 'flex'; 
                };
                g.appendChild(b);
            }
        }
        renderGrid();

        // --- PLACE BET ---
        window.placeBet = () => {
            if(isFrozen) return Swal.fire({icon:'error', title:'Time Up', text:'Betting is closed for this round.', background:'#1a1a1a', color:'#fff'});
            if(isBetting) return; 
            let a = parseInt(document.getElementById('bet-amt').value);
            if(!a || a < 1 || a > 1000) return Swal.fire({icon:'warning', title:'Invalid Amount', text:'Limit: ‚Çπ1 - ‚Çπ1000', background:'#1a1a1a', color:'#fff'});
            if(a > bal) return Swal.fire({icon:'error', text:'Insufficient Balance', background:'#1a1a1a', color:'#fff'});
            
            isBetting = true;
            document.getElementById('btn-confirm-bet').innerText = "Processing...";

            update(ref(db,'users/'+user.uid), {balance: bal-a})
            .then(() => {
                push(ref(db,`bets/${curRound}`), { uid: user.uid, bets: [{num: curNum, amt: a, type: curGameMode}], time: serverTimestamp() });
                document.getElementById('bet-popup').style.display='none'; document.getElementById('bet-amt').value="";
                Swal.fire({icon:'success', title:'Bet Placed', toast:true, position:'top-end', showConfirmButton:false, timer:1500, background:'#1a1a1a', color:'#fff'});
            })
            .catch((e) => Swal.fire({icon:'error', text:'Failed: ' + e.message, background:'#1a1a1a', color:'#fff'}))
            .finally(() => {
                isBetting = false; document.getElementById('btn-confirm-bet').innerText = "CONFIRM BET";
            });
        }

        // --- VIEW & CANCEL BETS ---
        window.openBetsModal = () => {
            document.getElementById('view-bets-modal').style.display = 'flex';
            document.getElementById('vb-rid').innerText = curRound;
            const list = document.getElementById('vb-list');
            list.innerHTML = '<div style="text-align:center;color:#666;">Fetching bets...</div>';

            get(ref(db, `bets/${curRound}`)).then((snapshot) => {
                if(!snapshot.exists()) {
                     list.innerHTML = '<div style="text-align:center; color:#555; padding:20px;">No bets placed in this round</div>';
                     return;
                }
                
                let myBets = [];
                snapshot.forEach(child => {
                    const data = child.val();
                    const key = child.key;
                    if(data.uid === user.uid && data.bets) {
                        data.bets.forEach(b => {
                            myBets.push({ key: key, ...b }); 
                        });
                    }
                });

                if(myBets.length === 0) {
                    list.innerHTML = '<div style="text-align:center; color:#555; padding:20px;">No bets placed in this round</div>';
                } else {
                    let html = "";
                    myBets.forEach(b => {
                        let color = b.type==='JODI' ? '#FFD700' : (b.type==='OPEN' ? '#00ff9d' : '#ff0055');
                        html += `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #333; color:#ccc;">
                            <div>
                                <span style="color:${color}; font-weight:bold; margin-right:5px;">${b.type}</span>
                                <span style="font-weight:bold; color:white;">[ ${b.num} ]</span>
                                <div style="color:#666; font-size:0.8rem;">‚Çπ${b.amt}</div>
                            </div>
                            <button onclick="window.cancelBet('${b.key}', ${b.amt})" style="background:#222; border:1px solid #444; color:var(--neon-red); padding:5px 12px; border-radius:5px; cursor:pointer;">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>`;
                    });
                    list.innerHTML = html;
                }
            });
        }

        window.cancelBet = (key, amt) => {
            if(isFrozen) return Swal.fire({icon:'error', title:'Locked', text:'Round is frozen. Cannot cancel now.', background:'#1a1a1a', color:'#fff'});
            
            Swal.fire({
                title: 'Cancel Bet?',
                text: "Refund ‚Çπ" + amt,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, cancel it!',
                background: '#1a1a1a', color: '#fff'
            }).then((result) => {
                if (result.isConfirmed) {
                    remove(ref(db, `bets/${curRound}/${key}`))
                    .then(() => {
                        const newBal = bal + parseInt(amt);
                        update(ref(db, 'users/'+user.uid), { balance: newBal });
                        Swal.fire({title:'Cancelled!', text:'Refund Successful.', icon:'success', background:'#1a1a1a', color:'#fff'});
                        window.openBetsModal();
                    })
                    .catch(err => Swal.fire({icon:'error', text:'Error: '+err.message, background:'#1a1a1a', color:'#fff'}));
                }
            });
        }

        // --- WALLET ---
        window.openDep = () => document.getElementById('dep-modal').style.display='flex';
        window.openWit = () => document.getElementById('wit-modal').style.display='flex';
        window.copyUpi = () => { 
            let upiVal = document.getElementById('dep-upi-txt-val').value;
            navigator.clipboard.writeText(upiVal); 
            Swal.fire({toast:true, title:'UPI Copied', position:'top', showConfirmButton:false, timer:1000, background:'#000', color:'#fff'}); 
        }
        
        // --- COMPRESS IMAGE FOR FAST UPLOAD ---
        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        // Resize to max 800px width (Good balance for quality/speed)
                        const MAX_WIDTH = 800; 
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        // Compress to JPEG at 70% quality
                        resolve(canvas.toDataURL('image/jpeg', 0.7)); 
                    }
                }
            });
        }

        window.subDep = () => {
            if(isTransacting) return;
            const btn = document.getElementById('btn-dep-sub');
            if(btn.disabled) return;

            let a = document.getElementById('d-amt').value, u = document.getElementById('d-utr').value;
            let f = document.getElementById('d-file').files[0];
            if(!a || !u) return Swal.fire({text:'Amount and UTR are required', background:'#1a1a1a', color:'#fff'});
            
            isTransacting = true;
            btn.disabled = true;
            btn.innerText = "Compressing & Uploading..."; // Feedback

            const pushTransaction = (imgData) => {
                 push(ref(db, 'transactions'), { uid: user.uid, email: user.email, type: 'DEPOSIT', amount: parseInt(a), detail: u, screenshot: imgData, status: 'PENDING', time: serverTimestamp() })
                 .then(() => {
                     document.getElementById('dep-modal').style.display='none'; 
                     // Clear inputs
                     document.getElementById('d-amt').value = '';
                     document.getElementById('d-utr').value = '';
                     document.getElementById('d-file').value = '';
                     document.getElementById('file-name-disp').innerText = '';

                     Swal.fire({icon:'success', text:'Request Sent', background:'#1a1a1a', color:'#fff'});
                     btn.disabled = false; btn.innerText = "SUBMIT REQUEST";
                 })
                 .catch(() => { btn.disabled = false; btn.innerText = "SUBMIT REQUEST"; })
                 .finally(() => { isTransacting = false; });
            };

            if(f){
                // USE COMPRESSOR
                compressImage(f).then(compressedBase64 => {
                    pushTransaction(compressedBase64);
                });
            } else { 
                pushTransaction("No Image"); 
            }
        }
        
        window.setWitMode = (m) => {
            witMethod = m;
            document.getElementById('btn-upi').classList.remove('active');
            document.getElementById('btn-bank').classList.remove('active');
            if(m === 'UPI'){
                document.getElementById('btn-upi').classList.add('active');
                document.getElementById('sec-upi').style.display = 'block';
                document.getElementById('sec-bank').style.display = 'none';
            } else {
                document.getElementById('btn-bank').classList.add('active');
                document.getElementById('sec-upi').style.display = 'none';
                document.getElementById('sec-bank').style.display = 'block';
            }
        }

        window.subWit = () => {
            if(isTransacting) return;
            const btn = document.getElementById('btn-wit-sub');
            if(btn.disabled) return;

            let amt = parseInt(document.getElementById('w-amt').value);
            let name = document.getElementById('w-name').value.trim();
            if(!amt || amt < 100) return Swal.fire({icon:'warning', text:'Min Withdrawal: ‚Çπ100'});
            if(amt > bal) return Swal.fire({icon:'error', text:'Insufficient Balance'});
            if(!name) return Swal.fire({icon:'warning', text:'Enter Account Holder Name'});

            let details = "", dataObj = {};
            if(witMethod === 'UPI'){
                let upiId = document.getElementById('w-upi-id').value.trim();
                if(!upiId) return Swal.fire({icon:'warning', text:'Enter UPI ID'});
                details = `UPI: ${upiId} | Name: ${name}`;
                dataObj = { upi: upiId, holder: name };
            } else {
                let acc = document.getElementById('w-acc').value.trim();
                let ifsc = document.getElementById('w-ifsc').value.trim();
                let bname = document.getElementById('w-bname').value.trim();
                if(!acc || !ifsc || !bname) return Swal.fire({icon:'warning', text:'Enter all Bank Details'});
                details = `Bank: ${bname} | Acc: ${acc} | IFSC: ${ifsc} | Name: ${name}`;
                dataObj = { bank: bname, acc: acc, ifsc: ifsc, holder: name };
            }
            
            isTransacting = true;
            btn.disabled = true;
            btn.innerText = "Processing...";

            push(ref(db,'transactions'), { uid: user.uid, email: user.email, type: 'WITHDRAW', method: witMethod, amount: amt, detail: details, fullData: dataObj, status: 'PENDING', time: serverTimestamp() })
            .then(() => {
                document.getElementById('wit-modal').style.display='none'; 
                Swal.fire({icon:'success', title:'Success', text:'Withdrawal Request Sent'});
                btn.disabled = false; btn.innerText = "REQUEST WITHDRAW";
            })
            .catch(() => { btn.disabled = false; btn.innerText = "REQUEST WITHDRAW"; })
            .finally(() => { isTransacting = false; });
        }

        function loadTx(){
            onValue(query(ref(db,'transactions'), limitToLast(20)), s=>{
                let h=""; if(s.exists()){ s.forEach(c=>{ let d=c.val(); if(d.uid===user.uid) { let color = d.type === 'DEPOSIT' ? 'var(--neon-green)' : 'var(--neon-red)'; h = `<div class="tx-item"><div><b style="color:${color}">${d.type}</b><br><span style="color:#666">${d.detail}</span></div><div style="text-align:right"><span style="background:${d.status==='SUCCESS'?'rgba(0,255,0,0.2)':'#333'}; color:${d.status==='SUCCESS'?'#00ff00':'#aaa'}; padding:2px 6px; border-radius:4px; font-size:0.7rem;">${d.status}</span><br><b style="color:white;">‚Çπ${d.amount}</b></div></div>` + h; } }); }
                document.getElementById('tx-list').innerHTML = h || '<div style="padding:20px;text-align:center;color:#555;">No recent transactions</div>';
            });
        }

        // --- HISTORY & RESULTS ---
        function fetchHist(){
            onValue(query(ref(db, 'results'), limitToLast(100)), (snapshot) => {
                if(snapshot.exists()){
                    globalHistoryData = [];
                    snapshot.forEach(child => { let v = child.val(); if(v.number !== undefined) globalHistoryData.push({ key: child.key, val: v }); });
                    renderHistoryUI(); 
                } else { document.getElementById('hist-list').innerHTML = '<div style="text-align:center; padding:30px; color:#555;">No Data Found</div>'; }
            });
        }

        function renderHistoryUI(){
            if(globalHistoryData.length === 0) return;
            const list = document.getElementById('hist-list');
            
            // FIX: USE SERVER TIME TO SYNC
            let now = Date.now() + serverTimeOffset; 
            
            let visibleItems = [];
            globalHistoryData.forEach(item => {
                let parts = item.key.split('-');
                let targetTime = new Date(parts[0], parts[1]-1, parts[2], parts[3], parts[4]).getTime();
                
                // Allow if time passed OR if it's extremely close (within 1 second)
                if(now >= targetTime) visibleItems.push({ ...item, actualTime: targetTime });
            });
            
            if(visibleItems.length === 0) { list.innerHTML = '<div style="text-align:center; padding:30px; color:#555;">No Results Yet</div>'; return; }
            visibleItems.sort((a, b) => b.actualTime - a.actualTime);
            let html = "";
            visibleItems.forEach(item => {
                let num = item.val.number.toString().padStart(2, '0');
                let timeStr = new Date(item.actualTime).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                html += `<div class="hist-item"><div><div style="color:var(--gold); font-weight:bold; font-size:0.9rem;">${timeStr}</div><div style="color:#666; font-size:0.7rem;">ID: ${item.key}</div></div><div class="hist-ball">${num}</div></div>`;
            });
            list.innerHTML = html;
        }

        function listenResult(){
            onChildAdded(query(ref(db,'results'), limitToLast(1)), async (snapshot) => {
                let roundID = snapshot.key, parts = roundID.split('-');
                let targetTime = new Date(parts[0], parts[1]-1, parts[2], parts[3], parts[4]).getTime();
                let now = Date.now();
                if(now < targetTime) {
                    pendingResultData = { snapshot: snapshot, roundID: roundID, triggerTime: targetTime };
                } else {
                    if (now - targetTime < 300000) showFinalResult({ snapshot: snapshot, roundID: roundID });
                }
            });
        }

        // RESULT LOGIC
        function showFinalResult(data) {
            let resultData = data.snapshot.val();
            let roundID = data.roundID;
            let resultNum = resultData.number.toString().padStart(2,'0');

            // Explicitly call render to show in list immediately
            renderHistoryUI();

            // Check if already paid
            get(ref(db, `users/${user.uid}/payouts/${roundID}`)).then(payoutSnap => {
                if(payoutSnap.exists()){
                    // Already Paid
                    document.getElementById('slot-display').innerText = resultNum;
                    document.getElementById('result-overlay').style.display = 'flex';
                    const resTitle = document.getElementById('res-title'), resMsg = document.getElementById('res-msg');
                    resTitle.innerText = "RESULT DECLARED"; resTitle.className = ""; resTitle.style.color = "white"; 
                    resMsg.innerHTML = "Round ended.";
                    return; 
                }

                document.getElementById('slot-display').innerText = resultNum;
                document.getElementById('result-overlay').style.display = 'flex';
                const resTitle = document.getElementById('res-title'), resMsg = document.getElementById('res-msg');
                resTitle.innerText = "RESULT DECLARED"; resTitle.className = ""; resTitle.style.color = "white"; resMsg.innerHTML = "Checking bets...";

                if(user){
                    get(ref(db, `bets/${roundID}`)).then(betSnap => {
                        let totalWin = 0, winDetails = "";
                        if(betSnap.exists()){
                            betSnap.forEach(child => {
                                let betData = child.val();
                                if(betData.uid === user.uid && betData.bets){
                                    betData.bets.forEach(b => {
                                        let isWin = false, winAmt = 0;
                                        if (b.type === 'JODI' && b.num === resultNum) { isWin = true; winAmt = b.amt * 90; } 
                                        else if (b.type === 'OPEN' && b.num === resultNum[0]) { isWin = true; winAmt = b.amt * 9; } 
                                        else if (b.type === 'CLOSE' && b.num === resultNum[1]) { isWin = true; winAmt = b.amt * 9; }
                                        if(isWin){ totalWin += winAmt; winDetails = `${b.type} (${b.num})`; }
                                    });
                                }
                            });
                        }
                        
                        set(ref(db, `users/${user.uid}/payouts/${roundID}`), { amount: totalWin, time: serverTimestamp() });

                        if(totalWin > 0){
                            // UNCOMMENTED FOR TESTING: Update Balance on Client Side
                            const newBal = bal + totalWin;
                            update(ref(db, 'users/'+user.uid), { balance: newBal });
                            
                            resTitle.innerText = "üéâ YOU WON! üéâ"; resTitle.style.color = "#00e676"; resTitle.className = "win-anim";
                            resMsg.innerHTML = `${winDetails}<br><span style="font-size:2rem; color:#fff; font-weight:bold;">+‚Çπ${totalWin}</span>`;
                            try{ confetti({particleCount: 150, spread: 70, origin: { y: 0.6 }}); }catch(e){}
                        } else { resMsg.innerHTML = "Better luck next time!"; }
                    });
                }
            });
            renderHistoryUI(); 
        }

        window.tab = (t,e) => {
            document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
            document.getElementById('tab-'+t).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
            e.classList.add('active');
        }
    </script>
</body>
</html>